<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Generated Report - Station Maintenance</title>
    <style>
        body {
            font-family: Segoe UI, Roboto, sans-serif;
            background: linear-gradient(180deg, #eef2f7 0%, #ffffff 100%);
            margin: 0;
            padding: 24px
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0 auto;
            background: transparent;
            padding: 0;
            box-shadow: none;
        }

        h1 {
            font-size: 26px;
            margin: 0 0 16px;
            color: #0b3a66;
            text-align: center;
            font-weight: 700;
        }

        .meta-table-4col {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 18px;
        }

        .meta-table-4col td {
            border: 1px solid black;
            padding: 8px 10px;
        }

        .meta-table-4col .label {
            font-weight: 600;
            width: 16%;
            background: none !important;
        }

        .module-section {
            background: none !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 25px 0 !important;
        }

        .module-title {
            font-size: 18px;
            font-weight: 700;
            color: black;
            padding: 0;
            margin: 0 0 8px 0;
            text-transform: uppercase;
        }

        .obs-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid black;
        }

        .obs-table th {
            border: 2px solid black;
            padding: 8px;
            font-size: 15px;
            background: none !important;
            color: black;
            font-weight: 600;
        }

        .obs-table td {
            border: 1.5px solid black;
            padding: 6px;
            font-size: 14px;
            color: black;
        }

        .img-thumb {
            max-width: 90px;
            max-height: 70px;
            border: 1px solid black;
            cursor: pointer;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 16px;
            border: 0;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            background: #007bff;
            font-size: 14px;
            font-weight: 600;
        }

        .btn.print {
            background: #16a34a;
        }

        .note {
            color: #64748b;
            font-size: 14px;
            margin-top: 12px;
            text-align: center;
        }

        .empty {
            padding: 24px;
            text-align: center;
            color: #666;
            font-size: 16px;
        }

        #imageModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #imageModal > div {
            position: relative;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        #imageModal img {
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 4px;
        }

        #imageModal span {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 32px;
            cursor: pointer;
            color: #333;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container" id="app">
        <h1>Station Maintenance Report (Generated)</h1>
        <div id="metaArea"></div>
        <div id="obsArea"></div>
        <div class="controls">
            <button class="btn" id="backBtn">Back</button>
            <button class="btn print" id="createPdfBtn">Create PDF</button>
            <button id="viewReportsBtn" class="btn" style="display:none;background:#6c5ce7;margin-left:10px;" disabled>
                View Reports
            </button>
        </div>
        <div class="note">If data is missing, go back to the create page and Save the station details first.</div>
    </div>

    <script>
        (function () {
            const zone = sessionStorage.getItem('zone') || '';
            const station = sessionStorage.getItem('station') || '';
            const date = sessionStorage.getItem('date') || '';

            const metaArea = document.getElementById('metaArea');
            const obsArea = document.getElementById('obsArea');
            const createBtn = document.getElementById('createPdfBtn');
            const viewBtn = document.getElementById('viewReportsBtn');

            function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

            function renderMeta(info) {
                // Single-row header: Zone, Station, Date
                metaArea.innerHTML = `
                    <table class="meta-table-4col">
                        <tr>
                            <td class="label">Zone</td>
                            <td>${escapeHtml(info.zone || '--')}</td>
                            <td class="label">Station</td>
                            <td>${escapeHtml(info.station || '--')}</td>
                            <td class="label">Date</td>
                            <td>${escapeHtml(info.date || '--')}</td>
                        </tr>
                    </table>
                `;
            }

            function renderObservations(observations) {
                if (!observations || observations.length === 0) {
                    obsArea.innerHTML = '<div class="empty">No observations found for this station entry.</div>';
                    return;
                }

                const CLEAN_NAME = {
                    'quarterly_check': 'SCHEDULE CHECK – QUARTERLY',
                    'daily_monthly': 'MAINTENANCE SCHEDULE – DAILY & MONTHLY',
                    'quarterly_half': 'MAINTENANCE SCHEDULE – QUARTERLY & HALF YEARLY'
                };

                const groups = {};
                observations.forEach(obs => {
                    const raw = (obs.module || '').toString().trim().toLowerCase();
                    const moduleName = CLEAN_NAME[raw] || raw.toUpperCase();
                    if (!groups[moduleName]) groups[moduleName] = [];
                    groups[moduleName].push(obs);
                });

                // ----- Summary: Total Points & Closed Points (similar to RIU) -----
                const totalPoints = observations.length;
                // Consider a point "closed" if there is any observed_value or remarks
                let closedPoints = 0;
                observations.forEach(o => {
                    const hasObserved = (o.observed_value || '').toString().trim() !== '';
                    const hasRemarks = (o.remarks || '').toString().trim() !== '';
                    if (hasObserved || hasRemarks) closedPoints++;
                });
                const openPoints = Math.max(0, totalPoints - closedPoints);
                const statusText = openPoints === 0 && totalPoints > 0 ? 'Completed' : 'Not Completed';

                // Update heading with status like RIU page
                const h1 = document.querySelector('h1');
                if (h1) {
                    h1.textContent = `Station Maintenance Report (Generated) — ${statusText}`;
                }

                // Build per-module open/closed status table (like RIU)
                const moduleStatuses = [];
                const moduleOrder = [
                    'SCHEDULE CHECK – QUARTERLY',
                    'MAINTENANCE SCHEDULE – DAILY & MONTHLY',
                    'MAINTENANCE SCHEDULE – QUARTERLY & HALF YEARLY'
                ];

                moduleOrder.forEach(name => {
                    const rows = groups[name] || [];
                    if (!rows.length) {
                        moduleStatuses.push({
                            name,
                            status: 'Not yet started'
                        });
                        return;
                    }
                    let moduleClosed = 0;
                    rows.forEach(o => {
                        const hasObs = (o.observed_value || '').toString().trim() !== '';
                        const hasRem = (o.remarks || '').toString().trim() !== '';
                        if (hasObs || hasRem) moduleClosed++;
                    });
                    const moduleOpen = Math.max(0, rows.length - moduleClosed);
                    let status;
                    if (moduleOpen === 0) status = 'Completed';
                    else status = `Open points: ${moduleOpen}`;
                    moduleStatuses.push({ name, status });
                });

                // Append overall + per-module summary block under meta table
                let summaryHtml = `
                    <div class="module-section">
                        <div class="module-title">Summary</div>
                        <table class="meta-table-4col">
                            <tr>
                                <td class="label">Total Points</td>
                                <td>${totalPoints}</td>
                                <td class="label">Closed Points</td>
                                <td>${closedPoints}</td>
                            </tr>
                        </table>
                        ${openPoints > 0 ? `<div style="margin-top:8px;"><em>${openPoints} point(s) still open overall.</em></div>` : ''}
                        <div style="margin-top:12px;">
                            <table class="meta-table-4col">
                                <tr>
                                    <td class="label">Module</td>
                                    <td colspan="3"><strong>Status</strong></td>
                                </tr>`;

                moduleStatuses.forEach(ms => {
                    summaryHtml += `
                                <tr>
                                    <td class="label">${escapeHtml(ms.name)}</td>
                                    <td colspan="3">${escapeHtml(ms.status)}</td>
                                </tr>`;
                });

                summaryHtml += `
                            </table>
                        </div>
                    </div>`;

                metaArea.innerHTML += summaryHtml;

                let tableHtml = '';
                const displayOrder = ['SCHEDULE CHECK – QUARTERLY', 'MAINTENANCE SCHEDULE – DAILY & MONTHLY', 'MAINTENANCE SCHEDULE – QUARTERLY & HALF YEARLY'];

                displayOrder.forEach(name => {
                    if (!groups[name]) return;

                    // Determine headers based on module name
                    let headers, cellMapping;
                    if (name === 'SCHEDULE CHECK – QUARTERLY') {
                        headers = ['S.No', 'Details of Equipment', 'Name/Number', 'Date of Commissioning', 'Required Value', 'Observed Value', 'Remarks', 'Images'];
                        cellMapping = {
                            s_no: 's_no',
                            col1: 'details',
                            col2: 'name_number',
                            col3: 'date_commission',
                            col4: 'required_value',
                            col5: 'observed_value',
                            col6: 'remarks'
                        };
                    } else {
                        // For daily_monthly and quarterly_half
                        headers = ['S.No', 'Location', 'Maintenance Task Description', 'Action taken/Range of Voltage levels', 'Frequency', 'Equipment condition', 'Remarks', 'Images'];
                        cellMapping = {
                            s_no: 's_no',
                            col1: 'name_number',  // Location
                            col2: 'details',      // Maintenance Task Description
                            col3: 'required_value', // Action taken/Range
                            col4: 'date_commission', // Frequency
                            col5: 'observed_value', // Equipment condition
                            col6: 'remarks'
                        };
                    }

                    tableHtml += `<div class="module-section">
                        <div class="module-title">${escapeHtml(name)}</div>
                        <div style="overflow-x:auto;">
                            <table class="obs-table">
                                <thead>
                                    <tr>
                                        ${headers.map(h => `<th style="width:${h === 'S.No' ? '5%' : h === 'Images' ? '10%' : '12%'}">${escapeHtml(h)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>`;

                    groups[name].forEach(obs => {
                        const images = Array.isArray(obs.image_paths) ? obs.image_paths.filter(Boolean)
                                   : (obs.image_path ? [obs.image_path] : []);
                        const imgHtml = images.length
                            ? images.map(p => `<img src="${escapeHtml(p)}" class="img-thumb" onclick="openImageModal('${escapeHtml(p)}')">`).join('')
                            : 'N/A';

                        tableHtml += `<tr>
                            <td>${escapeHtml(obs[cellMapping.s_no] || '')}</td>
                            <td>${escapeHtml(obs[cellMapping.col1] || '')}</td>
                            <td>${escapeHtml(obs[cellMapping.col2] || '')}</td>
                            <td>${escapeHtml(obs[cellMapping.col3] || '')}</td>
                            <td>${escapeHtml(obs[cellMapping.col4] || '')}</td>
                            <td>${escapeHtml(obs[cellMapping.col5] || '')}</td>
                            <td>${escapeHtml(obs[cellMapping.col6] || '')}</td>
                            <td style="text-align:center">${imgHtml}</td>
                        </tr>`;
                    });

                    tableHtml += `</tbody></table></div></div>`;
                });

                obsArea.innerHTML = tableHtml + `
                    <div id="imageModal">
                        <div style="position:relative;background:white;padding:14px;border-radius:8px;">
                            <span onclick="closeImageModal()" style="position:absolute;top:8px;right:12px;cursor:pointer;">×</span>
                            <img id="modalImage" src="" style="max-width:95vw;max-height:90vh;">
                        </div>
                    </div>`;
            }

            function openImageModal(imagePath) {
                document.getElementById('modalImage').src = imagePath;
                document.getElementById('imageModal').style.display = 'flex';
            }

            function closeImageModal() {
                document.getElementById('imageModal').style.display = 'none';
            }
            window.openImageModal = openImageModal;
            window.closeImageModal = closeImageModal;

            function showError(msg) {
                metaArea.innerHTML = `<div class="empty">${escapeHtml(msg)}</div>`;
                obsArea.innerHTML = '';
            }

            if (!zone || !station || !date) {
                showError('Station metadata is missing from session. Please go back to the create page and Save the station details first.');
                createBtn.disabled = true;
            } else {
                fetch('get_observations.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zone: zone, station: station, date: date })
                })
                    .then(r => r.json())
                    .then(json => {
                        if (json.station_info) renderMeta(json.station_info);
                        else renderMeta({ zone, station, date });
                        renderObservations(json.observations || []);
                    })
                    .catch(err => {
                        console.error(err);
                        showError('Failed to load data. Check network and server.');
                        createBtn.disabled = true;
                    });
            }

            document.getElementById('backBtn').addEventListener('click', function () { history.back(); });
            createBtn.addEventListener('click', createPDF);
            if (viewBtn) {
                viewBtn.addEventListener('click', function () {
                    window.location.href = 'viewReports.php';
                });
            }

            async function createPDF() {
                if (!zone || !station || !date) {
                    alert('Station metadata missing. Please go back and save station details.');
                    return;
                }

                createBtn.disabled = true;
                createBtn.innerText = 'Creating...';

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const contentWidth = 520;
                const startX = 40;

                // Collect observations (used for PDF body and to determine completion status)
                const obsRows = document.querySelectorAll('.obs-table tbody tr');
                const observations = [];
                obsRows.forEach(row => {
                    const cells = row.children;
                    const imgElements = cells[7]?.querySelectorAll('img') || [];
                    observations.push({
                        s_no: cells[0]?.innerText || '',
                        details: cells[1]?.innerText || '',
                        name_number: cells[2]?.innerText || '',
                        date_commission: cells[3]?.innerText || '',
                        required_value: cells[4]?.innerText || '',
                        observed_value: cells[5]?.innerText || '',
                        remarks: cells[6]?.innerText || '',
                        image_paths: Array.from(imgElements).map(img => img.src)
                    });
                });

                // Work out completion status for file name (similar criteria as summary)
                let closedPoints = 0;
                observations.forEach(o => {
                    const hasObs = (o.observed_value || '').toString().trim() !== '';
                    const hasRem = (o.remarks || '').toString().trim() !== '';
                    if (hasObs || hasRem) closedPoints++;
                });
                const totalPoints = observations.length;
                const openPoints = Math.max(0, totalPoints - closedPoints);
                const statusForName = (openPoints === 0 && totalPoints > 0) ? 'Completed' : 'NotCompleted';

                // Page 1 - Header
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('Station Maintenance Report', doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

                // Station Info Table
                doc.autoTable({
                    startY: 50,
                    head: [['Zone', 'Station', 'Date']],
                    body: [[zone || '--', station || '--', date || '--']],
                    theme: 'grid',
                    styles: { fontSize: 13, cellPadding: 10, lineColor: [0,0,0], lineWidth: 1.2 },
                    headStyles: { fillColor: [30,60,120], textColor: 255, fontStyle: 'bold', fontSize: 13 },
                    margin: { left: startX, right: startX }
                });

                let currentY = doc.lastAutoTable.finalY + 25;

                // Render each module table exactly as on screen
                document.querySelectorAll('.module-section').forEach(section => {
                    const moduleTitle = section.querySelector('.module-title')?.innerText || '';
                    const table = section.querySelector('.obs-table');
                    if (!table) return;

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(15);
                    doc.text(moduleTitle, startX, currentY);
                    currentY += 15;

                    const headerRow = table.querySelector('thead tr');
                    const headers = Array.from(headerRow?.cells || []).map(th => th.innerText.trim());

                    const tableBody = [];
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const cells = row.cells;
                        tableBody.push([
                            cells[0]?.innerText || '',
                            cells[1]?.innerText || '',
                            cells[2]?.innerText || '',
                            cells[3]?.innerText || '',
                            cells[4]?.innerText || '',
                            cells[5]?.innerText || '',
                            cells[6]?.innerText || '',
                            (cells[7]?.querySelectorAll('img').length > 0) ? '✓ Image' : 'N/A'
                        ]);
                    });

                    doc.autoTable({
                        startY: currentY,
                        head: [headers],
                        body: tableBody,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 4, lineColor: [0,0,0], lineWidth: 0.8 },
                        headStyles: { fillColor: [30,60,120], textColor: 255, fontStyle: 'bold', fontSize: 9 },
                        margin: { left: startX, right: startX },
                        tableWidth: contentWidth
                    });

                    currentY = doc.lastAutoTable.finalY + 20;

                    if (currentY > doc.internal.pageSize.getHeight() - 50) {
                        doc.addPage();
                        currentY = 50;
                    }
                });

                // Footer
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Generated on: ' + new Date().toLocaleDateString('en-IN') + ' at ' + new Date().toLocaleTimeString('en-IN'),
                    doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 20, { align: 'center' });

                // Create a server-friendly file name with status and timestamp
                function formatTs(d) {
                    const pad = (n) => String(n).padStart(2, '0');
                    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
                }
                const nowTs = formatTs(new Date());
                const safeZone = (zone || '--').toString().replace(/\s+/g, '_');
                const safeStation = (station || '--').toString().replace(/\s+/g, '_');
                const safeDate = (date || '--').toString().replace(/\//g, '-');
                const reportName = `STATION_${safeZone}_${safeStation}_${safeDate}_${statusForName}_${nowTs}.pdf`;

                try {
                    // Export PDF as base64 and send to backend for storage & versioning
                    const dataUri = doc.output('datauristring');
                    const base64 = dataUri.split(',')[1];

                    const payload = {
                        zone,
                        station,
                        date,
                        pdf_base64: base64,
                        report_name: reportName
                    };

                    const resp = await fetch('generate_pdf.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const json = await resp.json();
                    if (!json || !json.success) {
                        throw new Error(json && json.message ? json.message : 'Server error while saving PDF');
                    }

                    createBtn.disabled = false;
                    createBtn.innerText = 'Created';
                    alert('PDF Created & Saved Successfully.');

                    // Enable "View Reports" button now that at least one report exists
                    if (viewBtn) {
                        viewBtn.style.display = 'inline-block';
                        viewBtn.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                    createBtn.disabled = false;
                    createBtn.innerText = 'Create PDF';
                    alert('Failed to save PDF to server.');
                }
            }
        })();
    </script>
</body>
</html>

